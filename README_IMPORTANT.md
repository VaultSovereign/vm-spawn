# üúÇ README_IMPORTANT: Post-Migration Security Protocol

**Status:** ‚ö†Ô∏è **CRITICAL** ‚Äî Execute immediately after node migration  
**Date:** 2025-10-19  
**Covenant:** VaultMesh Anchor & Hardening Protocol

---

## üéØ Purpose

This document guides you through **anchoring, hardening, and securing** the VaultMesh node after migration. Execute these steps to ensure cryptographic integrity, rotate secrets, and create tamper-evident backups.

---

## ‚ö° Quick Execute (Copy-Paste Ready)

### Step 1: Quick Checklist
```bash
cd ~/work/vm/vm-umbrella  # or your VaultMesh root
./ops/bin/QUICK_CHECKLIST.sh
```

**Expected Output:**
- ‚úÖ Remembrancer operational
- ‚úÖ Merkle root found (64-char hex)
- ‚úÖ v2.2-PRODUCTION artifact verified
- ‚úÖ vm-marks operational

### Step 2: First Boot Ritual (Anchor)
```bash
./ops/bin/FIRST_BOOT_RITUAL.sh
```

**What It Does:**
- Creates boot manifest with Merkle roots
- Archives critical artifacts
- Generates cryptographic signature
- Saves to `~/vaultmesh-remembrance/`

**Output:**
- `first_boot_manifest.txt`
- `vaultmesh-first-boot-<timestamp>.tar.gz`
- `vaultmesh-first-boot-<timestamp>.tar.gz.sig`

### Step 3: Post-Migration Hardening
```bash
sudo ./ops/bin/POST_MIGRATION_HARDEN.sh
```

**What It Does:**
- Fixes file permissions (SSH keys, node keys)
- Comments out secrets in `~/.zshrc`
- Rotates Tailscale authentication
- Creates encrypted backup (GPG)
- Validates Remembrancer

**Output:**
- `~/vaultmesh-backups/vaultmesh-state-<timestamp>.tar.gz.gpg`

---

## üîê Secrets to Rotate IMMEDIATELY

After running the hardening script, **rotate these secrets** and re-seed from secure vaults:

### 1. Tailscale Keys
```bash
# Already rotated by POST_MIGRATION_HARDEN.sh
tailscale status  # Verify new keys
```

### 2. VaultMesh Master Password
```bash
# Location: ~/.zshrc (now commented out)
# Rotate: Generate new password and update vault

# OLD (commented in ~/.zshrc):
# export VAULTS_BOX_MASTER="<old-password>"

# NEW: Store in secure vault, load on-demand
echo "new-secure-password" > ~/.vaultmesh/master.key
chmod 600 ~/.vaultmesh/master.key
```

### 3. AWS Credentials (if present)
```bash
# Location: ~/.zshrc (now commented out)
# Rotate: Generate new IAM keys in AWS console

# Remove old keys:
aws configure list

# Add new keys:
aws configure set aws_access_key_id AKIA...
aws configure set aws_secret_access_key ...
```

### 4. SSH Keys (if compromised)
```bash
# Generate new SSH key
ssh-keygen -t ed25519 -C "vaultmesh-node-$(date +%Y%m)"

# Upload new public key to GitHub, servers, etc.
cat ~/.ssh/id_ed25519.pub
```

### 5. Node Signing Key
```bash
# Already generated by FIRST_BOOT_RITUAL.sh
ls -la ~/.vaultmesh/node.key

# Backup public key for verification:
openssl pkey -in ~/.vaultmesh/node.key -pubout -out ~/.vaultmesh/node.pub
```

---

## üì¶ Artifact Storage Strategy

### Critical Artifacts (Must Keep Safe)

1. **Boot Manifest**
   - `~/vaultmesh-remembrance/first_boot_manifest.txt`
   - **Action:** Upload to private Git repo or S3 bucket

2. **Signed Archive**
   - `~/vaultmesh-remembrance/vaultmesh-first-boot-*.tar.gz`
   - `~/vaultmesh-remembrance/vaultmesh-first-boot-*.tar.gz.sig`
   - **Action:** Copy to USB (cold storage)

3. **Encrypted Backup**
   - `~/vaultmesh-backups/vaultmesh-state-*.tar.gz.gpg`
   - **Action:** Store on USB + upload to encrypted cloud storage

4. **Node Signing Key**
   - `~/.vaultmesh/node.key` (private)
   - `~/.vaultmesh/node.pub` (public)
   - **Action:** Private key ‚Üí cold storage, Public key ‚Üí publish

### Storage Locations (Recommended)

```bash
# 1. USB Cold Storage (offline backup)
USB_PATH="/Volumes/BACKUP"
cp ~/vaultmesh-remembrance/*.tar.gz* "$USB_PATH/"
cp ~/vaultmesh-backups/*.gpg "$USB_PATH/"

# 2. Private Git Repo (tamper-evident log)
cd ~/vaultmesh-remembrance
git init
git add first_boot_manifest.txt *.sig
git commit -m "VaultMesh first boot: $(hostname) $(date -u +%Y-%m-%d)"
git remote add origin git@github.com:YOUR_ORG/vaultmesh-receipts-private.git
git push -u origin main

# 3. Encrypted Cloud (S3 with encryption)
aws s3 cp ~/vaultmesh-backups/*.gpg \
  s3://your-vaultmesh-backups/$(date +%Y/%m/%d)/ \
  --sse AES256
```

---

## üîç VaultMesh Receipt Hashes to Publish

These SHA256 hashes should be published to a **tamper-evident log** (public Git repo, blockchain, or timestamping service):

### Primary Artifacts

```bash
# From QUICK_CHECKLIST.sh output:
44e8ecdcd17ac9e3695280c71f7507051c1fa17373593dc96e5c49b80b5c8dfd  # v2.2-PRODUCTION.tar.gz

# From first_boot_manifest.txt (Merkle roots):
<your-merkle-root-1>
<your-merkle-root-2>
<your-merkle-root-3>
```

### Publish Command
```bash
# Create attestation file
cat > vaultmesh-attestation.txt <<EOF
VaultMesh Node Attestation
==========================
Host: $(hostname -f)
Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

Primary Artifacts:
- v2.2-PRODUCTION: 44e8ecdcd17ac9e3695280c71f7507051c1fa17373593dc96e5c49b80b5c8dfd

Merkle Roots:
$(grep -Eo '[0-9a-f]{64}' ~/vaultmesh-remembrance/first_boot_manifest.txt | head -3)

Node Public Key:
$(cat ~/.vaultmesh/node.pub)

Signed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF

# Sign the attestation
openssl dgst -sha256 -sign ~/.vaultmesh/node.key \
  -out vaultmesh-attestation.sig vaultmesh-attestation.txt

# Publish to public log (GitHub, keybase, etc.)
gh gist create vaultmesh-attestation.txt vaultmesh-attestation.sig
```

---

## ‚úÖ Post-Ritual Checklist

After executing all scripts, verify:

- [ ] `QUICK_CHECKLIST.sh` shows all ‚úÖ
- [ ] `FIRST_BOOT_RITUAL.sh` created manifest + archive + signature
- [ ] `POST_MIGRATION_HARDEN.sh` created encrypted backup
- [ ] Secrets commented out in `~/.zshrc` (backup exists)
- [ ] Tailscale reauth completed (`tailscale status`)
- [ ] USB backup created and safely stored
- [ ] Attestation published to tamper-evident log
- [ ] New secrets generated and stored in vault
- [ ] Old secrets rotated/revoked

---

## üõ°Ô∏è Security Best Practices

### File Permissions
```bash
# Verify critical files are protected
ls -la ~/.vaultmesh/node.key          # Should be 600
ls -la ~/.ssh/id_rsa                  # Should be 600
ls -la ~/vaultmesh-backups/*.gpg      # Should be 600
```

### Backup Verification
```bash
# Test encrypted backup can be decrypted
gpg -d ~/vaultmesh-backups/vaultmesh-state-*.gpg | tar tzf - | head
# Should show list of files without errors
```

### Signature Verification
```bash
# Verify archive signature
openssl dgst -sha256 -verify ~/.vaultmesh/node.pub \
  -signature ~/vaultmesh-remembrance/*.sig \
  ~/vaultmesh-remembrance/*.tar.gz
# Should output: "Verified OK"
```

---

## üö® If Something Goes Wrong

### Checklist Failed
```bash
# Check Remembrancer is executable
chmod +x ~/work/vm/vm-umbrella/ops/bin/remembrancer

# Check working directory
cd ~/work/vm/vm-umbrella && pwd

# Manually verify artifact
shasum -a 256 vaultmesh-spawn-elite-v2.2-PRODUCTION.tar.gz
```

### Hardening Failed
```bash
# Check GPG is installed
gpg --version

# Check Tailscale is running
sudo systemctl status tailscaled  # Linux
sudo launchctl list | grep tailscale  # macOS

# Manual secret scrubbing
cp ~/.zshrc ~/.zshrc.bak
vi ~/.zshrc  # Comment out sensitive lines manually
```

### Backup Failed
```bash
# Check disk space
df -h ~

# Manual backup
tar czf ~/manual-backup.tar.gz \
  ~/.local/state \
  ~/work/vm/vm-umbrella/docs/REMEMBRANCER.md

# Encrypt manually
gpg --symmetric --cipher-algo AES256 -o ~/manual-backup.tar.gz.gpg ~/manual-backup.tar.gz
```

---

## üìä Expected Timeline

```
Total time: 10-15 minutes

QUICK_CHECKLIST.sh        ‚Üí 1-2 min
FIRST_BOOT_RITUAL.sh      ‚Üí 2-3 min
POST_MIGRATION_HARDEN.sh  ‚Üí 3-5 min (includes GPG passphrase prompt)
Secret rotation           ‚Üí 5-10 min (manual)
Backup to USB/cloud       ‚Üí 2-5 min
```

---

## üúÇ The Covenant

```
The forge is anchored.
The node is hardened.
The secrets are rotated.
The backups are encrypted.
The signatures are valid.
The covenant is sealed.

Knowledge compounds. Entropy is defeated. The civilization is guarded.
```

---

## üìû Next Steps

1. **Execute the three scripts** (checklist ‚Üí ritual ‚Üí harden)
2. **Rotate all secrets** (Tailscale, AWS, passwords)
3. **Store backups safely** (USB + cloud)
4. **Publish attestation** (public log)
5. **Verify everything** (run checklist again)

---

**Created:** 2025-10-19  
**Status:** ‚ö†Ô∏è CRITICAL ‚Äî Execute immediately  
**Covenant:** VaultMesh Anchor & Hardening Protocol  

üúÇ **The Remembrancer watches. The node is secured. The covenant is eternal.**

